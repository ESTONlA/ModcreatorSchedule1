name: Release Stable

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.0)'
        required: false
        type: string

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Extract version from project or tag
      id: get_version
      run: |
        if (${{ github.event_name }} == 'push' && ${{ startsWith(github.ref, 'refs/tags/v') }}) {
          $version = ${{ github.ref_name }}.Substring(1)
        } elseif (${{ github.event.inputs.version }}) {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = Select-String -Path "Schedule1ModdingTool.csproj" -Pattern '<Version>(.*)</Version>' | ForEach-Object { $_.Matches.Groups[1].Value }
          # Remove beta suffix if present
          $version = $version -replace '-beta.*', ''
        }
        if ([string]::IsNullOrWhiteSpace($version)) {
          $version = "1.0.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_ENV
        echo "version=$version" >> $env:GITHUB_OUTPUT

    - name: Build Release
      run: dotnet build Schedule1ModdingTool.csproj -c Release -p:Version=$env:VERSION

    - name: Publish Release
      run: dotnet publish Schedule1ModdingTool.csproj -c Release -p:Version=$env:VERSION -o ./publish --self-contained false

    - name: Create release archive
      run: |
        $archiveName = "Schedule1ModdingTool-$env:VERSION-stable.zip"
        Compress-Archive -Path "publish\*" -DestinationPath $archiveName -Force
        echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV

    - name: Generate release notes
      id: release_notes
      run: |
        $notes = "## Stable Release $env:VERSION`n`n"
        if (Test-Path "CHANGELOG.md") {
          $changelog = Get-Content "CHANGELOG.md" -Raw
          $notes += $changelog
        } else {
          $notes += "### Changes`n"
          $notes += "See commit history for details."
        }
        echo "notes<<EOF" >> $env:GITHUB_OUTPUT
        echo "$notes" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.VERSION }}
        name: Stable Release ${{ env.VERSION }}
        body: ${{ steps.release_notes.outputs.notes }}
        prerelease: false
        files: ${{ env.ARCHIVE_NAME }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

